# Contract Tests: start-planning command
#
# Tests that the planning command behaves correctly:
# - Creates files in the right location
# - Includes required structural elements (phases, tasks)
# - Records format choice in frontmatter
# - Handles edge cases appropriately
#
# These tests are BEHAVIORAL - they verify the skill works,
# not that it produces specific content.
#
# Note: The command runs /migrate first (Step 0), then discovery,
# then follows routing based on specification state.

name: "start-planning contracts"
description: "Verify planning command creates correct plan structure"
type: contract

scenarios:
  # ==========================================================================
  # Happy Path: Create plan from specification
  # ==========================================================================
  - name: "creates plan from specification"
    description: "When specification exists, creates planning document"
    fixture: minimal/has-specification
    command: /workflow/start-planning
    choices:
      - match: "specification"
        answer: "test-topic"
      - match: "format"
        answer: "local-markdown"
    assertions:
      # File created in correct location
      - exists: docs/workflow/planning/test-topic.md
      # Planning uses YAML frontmatter with format field
      - has_frontmatter:
          path: docs/workflow/planning/test-topic.md
          required:
            - format
      # Has phases section
      - has_sections:
          path: docs/workflow/planning/test-topic.md
          sections:
            - "## Overview"
    invariants:
      # Source documents should not be modified
      - docs/workflow/specification/*

  # ==========================================================================
  # Format Selection
  # ==========================================================================
  - name: "records selected format in frontmatter"
    description: "Plan frontmatter includes the output format choice"
    fixture: minimal/has-specification
    command: /workflow/start-planning
    choices:
      - match: "specification"
        answer: "test-topic"
      - match: "format"
        answer: "local-markdown"
    assertions:
      - has_frontmatter:
          path: docs/workflow/planning/test-topic.md
          values:
            format: "local-markdown"

  # ==========================================================================
  # Edge Case: No specification exists
  # ==========================================================================
  - name: "requires specification to create plan"
    description: "Without specification, should not create plan"
    fixture: minimal/has-discussion  # Has discussion but no spec
    command: /workflow/start-planning
    choices:
      - match: "specification"
        answer: ""
      - match: "topic"
        answer: ""
    assertions:
      - file_count:
          pattern: docs/workflow/planning/*.md
          count: 0

  # ==========================================================================
  # Plan Structure: Phases and Tasks
  # ==========================================================================
  - name: "plan includes phases"
    description: "Generated plan should have phase structure"
    fixture: minimal/has-specification
    command: /workflow/start-planning
    choices:
      - match: "specification"
        answer: "test-topic"
      - match: "format"
        answer: "local-markdown"
    assertions:
      - exists: docs/workflow/planning/test-topic.md
      # Should contain phase headings
      - content_matches:
          path: docs/workflow/planning/test-topic.md
          pattern: "(Phase|### Phase)"
          flags: "i"

  # ==========================================================================
  # Plan Structure: External Dependencies
  # ==========================================================================
  - name: "plan includes external dependencies section"
    description: "Plan should have external dependencies section"
    fixture: minimal/has-specification
    command: /workflow/start-planning
    choices:
      - match: "specification"
        answer: "test-topic"
      - match: "format"
        answer: "local-markdown"
    assertions:
      - exists: docs/workflow/planning/test-topic.md
      - has_sections:
          path: docs/workflow/planning/test-topic.md
          sections:
            - "## External Dependencies"
