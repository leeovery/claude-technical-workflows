# Contract Tests: start-specification command
#
# Tests logic paths and structural outputs of the specification command.
# These tests are deterministic and don't require LLM judging.

name: "start-specification contracts"
description: "Verify specification command creates correct file structure"
type: contract

scenarios:
  # ==========================================================================
  # Happy Path: Create spec from existing discussion
  # ==========================================================================
  - name: "creates spec from discussion"
    description: "When discussion exists, creates specification with correct structure"
    fixture: minimal/has-discussion
    command: /workflow/start-specification
    choices:
      - match: "topic"
        answer: "test-topic"
      - match: "proceed"
        answer: "yes"
    assertions:
      - exists: docs/workflow/specification/test-topic.md
      - has_frontmatter:
          path: docs/workflow/specification/test-topic.md
          required:
            - topic
            - status
      - has_sections:
          path: docs/workflow/specification/test-topic.md
          sections:
            - "## Summary"
            - "## Validated Decisions"
    invariants:
      - docs/workflow/discussion/*
      - docs/workflow/research/*

  # ==========================================================================
  # Edge Case: Multiple discussions available
  # ==========================================================================
  - name: "prompts for topic when multiple discussions exist"
    description: "With multiple discussions, user must select which topic"
    fixture: minimal/has-discussion
    command: /workflow/start-specification
    choices:
      - match: "topic"
        answer: "test-topic"
    assertions:
      - exists: docs/workflow/specification/test-topic.md
      - file_count:
          pattern: docs/workflow/specification/*.md
          count: 1

  # ==========================================================================
  # Edge Case: No discussion exists
  # ==========================================================================
  - name: "handles missing discussion gracefully"
    description: "Without discussion, prompts for inline context or explains requirement"
    fixture: minimal/empty
    command: /workflow/start-specification
    choices:
      - match: "context"
        answer: ""  # User declines to provide context
    assertions:
      # Should not create file without input
      - not_exists: docs/workflow/specification/*.md
      - output_contains:
          - "discussion"

  # ==========================================================================
  # Edge Case: Specification already exists
  # ==========================================================================
  - name: "warns when specification already exists"
    description: "If spec exists for topic, should warn about overwriting"
    fixture: minimal/has-specification
    command: /workflow/start-specification
    choices:
      - match: "topic"
        answer: "test-topic"
      - match: "overwrite"
        answer: "no"
    assertions:
      # Original should be unchanged
      - unchanged: docs/workflow/specification/test-topic.md

  # ==========================================================================
  # Structure Validation
  # ==========================================================================
  - name: "spec includes source reference"
    description: "Specification should reference its source (discussion)"
    fixture: minimal/has-discussion
    command: /workflow/start-specification
    choices:
      - match: "topic"
        answer: "test-topic"
    assertions:
      - exists: docs/workflow/specification/test-topic.md
      - content_matches:
          path: docs/workflow/specification/test-topic.md
          pattern: "source:|Source:|discussion"
          flags: "i"
