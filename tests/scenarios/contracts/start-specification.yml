# Contract Tests: start-specification command
#
# Tests that the specification command behaves correctly:
# - Creates files in the right location
# - Includes required structural elements
# - Handles edge cases appropriately
#
# These tests are BEHAVIORAL - they verify the skill works,
# not that it produces specific content.

name: "start-specification contracts"
description: "Verify specification command creates correct file structure"
type: contract

scenarios:
  # ==========================================================================
  # Happy Path: Create spec from existing discussion
  # ==========================================================================
  - name: "creates spec from discussion"
    description: "When discussion exists, creates specification file"
    fixture: minimal/has-discussion
    command: /workflow/start-specification
    choices:
      - match: "topic"
        answer: "test-topic"
      - match: "proceed"
        answer: "yes"
      - match: "approve"
        answer: "yes"
    assertions:
      # File created in correct location
      - exists: docs/workflow/specification/test-topic.md
      # Has required sections per skill definition
      - has_sections:
          path: docs/workflow/specification/test-topic.md
          sections:
            - "# Specification"
            - "## Dependencies"
      # Has inline metadata (not YAML frontmatter)
      - content_matches:
          path: docs/workflow/specification/test-topic.md
          pattern: "\\*\\*Status\\*\\*:"
    invariants:
      # Discussion should not be modified
      - docs/workflow/discussion/*

  # ==========================================================================
  # Edge Case: No discussion exists
  # ==========================================================================
  - name: "handles missing discussion"
    description: "Without discussion, should not create spec without user input"
    fixture: minimal/empty
    command: /workflow/start-specification
    choices:
      - match: "context"
        answer: ""  # User declines to provide context
      - match: "topic"
        answer: ""
    assertions:
      # Should not create file without proper input
      - file_count:
          pattern: docs/workflow/specification/*.md
          count: 0

  # ==========================================================================
  # Edge Case: Specification already exists
  # ==========================================================================
  - name: "respects existing specification"
    description: "If spec exists and user declines overwrite, original preserved"
    fixture: minimal/has-specification
    command: /workflow/start-specification
    choices:
      - match: "topic"
        answer: "test-topic"
      - match: "overwrite"
        answer: "no"
      - match: "exist"
        answer: "no"
    assertions:
      # Original should be unchanged
      - unchanged: docs/workflow/specification/test-topic.md

  # ==========================================================================
  # Structure: Dependencies section is mandatory
  # ==========================================================================
  - name: "includes dependencies section"
    description: "Specification must include Dependencies section per skill rules"
    fixture: minimal/has-discussion
    command: /workflow/start-specification
    choices:
      - match: "topic"
        answer: "test-topic"
      - match: "approve"
        answer: "yes"
    assertions:
      - exists: docs/workflow/specification/test-topic.md
      # Dependencies section is MANDATORY per skill definition
      - has_sections:
          path: docs/workflow/specification/test-topic.md
          sections:
            - "## Dependencies"
