# Contract Tests: start-specification command
#
# Tests that the specification command behaves correctly:
# - Creates files in the right location
# - Includes required structural elements
# - Handles edge cases appropriately
#
# These tests are BEHAVIORAL - they verify the skill works,
# not that it produces specific content.
#
# Note: The command runs /migrate first (Step 0), then discovery,
# then follows routing based on discussion/spec state.

name: "start-specification contracts"
description: "Verify specification command creates correct file structure"
type: contract

scenarios:
  # ==========================================================================
  # Happy Path: Create spec from existing discussion (single discussion)
  # ==========================================================================
  - name: "creates spec from discussion"
    description: "When single concluded discussion exists, creates specification file"
    fixture: minimal/has-discussion
    command: /workflow/start-specification
    choices:
      # Step 9: Confirm selection - "Proceed? (y/n)"
      - match: "proceed"
        answer: "y"
      - match: "confirm"
        answer: "yes"
      # Step 10: Additional context - "Any additional context?"
      - match: "additional"
        answer: "none"
      - match: "context"
        answer: "none"
      # Skill may ask for approval
      - match: "approve"
        answer: "yes"
    assertions:
      # File created in correct location
      - exists: docs/workflow/specification/test-topic.md
      # Has required sections per skill definition
      - has_sections:
          path: docs/workflow/specification/test-topic.md
          sections:
            - "# Specification"
            - "## Dependencies"
      # Has inline metadata
      - content_matches:
          path: docs/workflow/specification/test-topic.md
          pattern: "\\*\\*Status\\*\\*:"
    invariants:
      # Discussion should not be modified
      - docs/workflow/discussion/*

  # ==========================================================================
  # Edge Case: No discussion exists
  # ==========================================================================
  - name: "handles missing discussion"
    description: "Without discussion, command stops and asks user to run /start-discussion first"
    fixture: minimal/empty
    command: /workflow/start-specification
    choices:
      # Command should stop with message, may wait for acknowledgment
      - match: "acknowledge"
        answer: "ok"
      - match: "understood"
        answer: "yes"
    assertions:
      # Should not create any specification file
      - file_count:
          pattern: docs/workflow/specification/*.md
          count: 0

  # ==========================================================================
  # Edge Case: Specification already exists - user continues it
  # ==========================================================================
  - name: "continues existing specification"
    description: "When spec exists for the discussion, continues/refines it"
    fixture: minimal/has-specification
    command: /workflow/start-specification
    choices:
      # With single discussion that has spec, it auto-routes to continue
      # Step 9: Confirm selection
      - match: "proceed"
        answer: "y"
      - match: "confirm"
        answer: "yes"
      # Step 10: Additional context
      - match: "additional"
        answer: "none"
      - match: "context"
        answer: "none"
      # Skill approval
      - match: "approve"
        answer: "yes"
    assertions:
      # Spec file should still exist (may be updated)
      - exists: docs/workflow/specification/test-topic.md
      # Should have required sections
      - has_sections:
          path: docs/workflow/specification/test-topic.md
          sections:
            - "# Specification"
            - "## Dependencies"

  # ==========================================================================
  # Structure: Dependencies section is mandatory
  # ==========================================================================
  - name: "includes dependencies section"
    description: "Specification must include Dependencies section per skill rules"
    fixture: minimal/has-discussion
    command: /workflow/start-specification
    choices:
      - match: "proceed"
        answer: "y"
      - match: "additional"
        answer: "none"
      - match: "approve"
        answer: "yes"
    assertions:
      - exists: docs/workflow/specification/test-topic.md
      # Dependencies section is MANDATORY per skill definition
      - has_sections:
          path: docs/workflow/specification/test-topic.md
          sections:
            - "## Dependencies"
